<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daggerheart Campaign Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --hope-gold: #fbbf24;
            --fear-purple: #8b5cf6;
            --void-dark: #0f172a;
        }
        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--void-dark);
            color: #e2e8f0;
        }
        h1, h2, h3, .fantasy-font {
            font-family: 'Cinzel', serif;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes roll {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .rolling {
            animation: roll 0.5s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-fixed bg-center" id="body-bg">
    
    <div class="fixed inset-0 bg-slate-950/90 z-[-1]"></div>

    <!-- Navigation -->
    <nav class="border-b border-white/10 glass-panel sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-2">
                    <i data-lucide="sword" class="text-amber-400 w-6 h-6"></i>
                    <span class="text-xl font-bold fantasy-font tracking-wider text-white">Campaign Nexus</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="#heroes" class="hover:text-amber-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">Heroes</a>
                        <a href="#session" class="hover:text-amber-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">Session Log</a>
                    </div>
                </div>
                <button onclick="toggleDiceOverlay()" class="md:hidden text-amber-400">
                    <i data-lucide="dices" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Hero Section -->
        <div class="text-center py-16 lg:py-24 relative overflow-hidden rounded-3xl border border-white/10 glass-panel mb-16 shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 via-purple-600 to-amber-500 opacity-75"></div>
            
            <h1 id="campaign-title" class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-white to-purple-200 mb-6 drop-shadow-lg">
                Loading Campaign...
            </h1>
            <p id="campaign-desc" class="mt-4 text-xl text-slate-300 max-w-2xl mx-auto font-light"></p>
            
            <div class="mt-10 flex justify-center gap-4">
                <a id="next-session-link" href="#session" target="_blank" class="px-8 py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg shadow-lg shadow-amber-900/50 transition-all flex items-center gap-2">
                    <i data-lucide="calendar"></i> <span id="next-session-btn">Next Session: TBD</span>
                </a>
                <button onclick="rollDuality()" class="px-8 py-3 bg-purple-900/50 hover:bg-purple-800 border border-purple-500 text-purple-200 font-bold rounded-lg transition-all flex items-center gap-2">
                    <i data-lucide="dices"></i> Roll Duality
                </button>
            </div>
        </div>

        <!-- Duality Dice Section -->
        <div id="dice-section" class="mb-16 glass-panel p-8 rounded-2xl border border-white/5 text-center transition-all duration-500 hidden opacity-0">
            <h2 class="text-2xl fantasy-font text-white mb-6">Duality Roll</h2>
            <div class="flex justify-center items-center gap-12 mb-8">
                <div class="text-center">
                    <p class="text-amber-400 uppercase tracking-widest text-xs font-bold mb-2">Hope</p>
                    <div id="hope-die" class="w-24 h-24 bg-gradient-to-br from-amber-400 to-amber-600 rounded-xl flex items-center justify-center text-4xl font-bold text-black shadow-lg shadow-amber-500/20">?</div>
                </div>
                <div class="text-center">
                    <p class="text-purple-400 uppercase tracking-widest text-xs font-bold mb-2">Fear</p>
                    <div id="fear-die" class="w-24 h-24 bg-gradient-to-br from-purple-500 to-purple-900 rounded-xl flex items-center justify-center text-4xl font-bold text-white shadow-lg shadow-purple-500/20">?</div>
                </div>
            </div>
            <div id="result-message" class="text-xl font-bold text-white min-h-[2rem]"></div>
        </div>

        <!-- Heroes Grid -->
        <section id="heroes" class="mb-20">
            <h2 class="text-3xl fantasy-font text-white mb-8 border-b border-white/10 pb-4 flex items-center gap-3">
                <i data-lucide="users" class="text-amber-500"></i> The Party
            </h2>
            <div id="heroes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>

        <!-- Session Logs -->
        <section id="session" class="mb-20">
            <h2 class="text-3xl fantasy-font text-white mb-8 border-b border-white/10 pb-4 flex items-center gap-3">
                <i data-lucide="book-open" class="text-purple-500"></i> Session Logs
            </h2>
            <div id="session-list" class="space-y-4"></div>
        </section>

    </main>

    <footer class="bg-slate-950 border-t border-white/10 py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-500 mb-2">Campaign Portal built for Daggerheart</p>
            <p class="text-slate-700 text-sm">Unofficial Fan Content. Daggerheart is a trademark of Darrington Press.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('../data/campaign.yml')
                .then(response => response.text())
                .then(text => {
                    const data = jsyaml.load(text);
                    renderSite(data);
                    
                    // Fetch real calendar data from our backend service
                    fetchNextSession(); 
                })
                .catch(e => {
                    console.error("Could not load campaign.yml", e);
                    document.getElementById('campaign-title').innerText = "Error Loading Config";
                });
        });

        function fetchNextSession() {
            // We are calling our local backend now, NOT Google API directly
            fetch('http://localhost:5000/api/next-session')
                .then(res => {
                    if (!res.ok) throw new Error("API Error");
                    return res.json();
                })
                .then(data => {
                    if (data.date) {
                        const btnText = document.getElementById('next-session-btn');
                        const btnLink = document.getElementById('next-session-link');
                        btnText.textContent = `Next Session: ${data.date}`;
                        if (data.link) {
                            btnLink.href = data.link;
                        }
                    }
                })
                .catch(err => {
                    console.log("Could not fetch calendar data, using default.", err);
                });
        }

        function renderSite(data) {
            document.getElementById('campaign-title').textContent = data.campaign.title;
            document.getElementById('campaign-desc').textContent = data.campaign.description;
            if(data.campaign.backgroundImage) {
                document.getElementById('body-bg').style.backgroundImage = `url('${data.campaign.backgroundImage}')`;
            }
            if(data.campaign.nextSession) {
                document.getElementById('next-session-btn').textContent = `Next Session: ${data.campaign.nextSession}`;
            }

            const heroesContainer = document.getElementById('heroes-grid');
            heroesContainer.innerHTML = ''; 
            data.heroes.forEach(hero => {
                let borderColor = hero.color === 'purple' ? 'border-purple-500' : 
                                  hero.color === 'emerald' ? 'border-emerald-500' : 'border-amber-500';
                let iconColor = hero.color === 'purple' ? 'text-purple-500' : 
                                hero.color === 'emerald' ? 'text-emerald-500' : 'text-amber-500';
                let subTextColor = hero.color === 'purple' ? 'text-purple-400' : 
                                   hero.color === 'emerald' ? 'text-emerald-400' : 'text-amber-400';

                const tagsHtml = hero.tags.map(tag => 
                    `<span class="px-2 py-1 bg-slate-700 text-xs rounded text-slate-300">${tag}</span>`
                ).join('');

                const html = `
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 card-hover transition-all duration-300 group">
                    <div class="h-48 bg-cover bg-center" style="background-image: url('${hero.image}');">
                        <div class="w-full h-full bg-black/40 group-hover:bg-black/20 transition-all"></div>
                    </div>
                    <div class="p-6 relative">
                        <div class="absolute -top-8 right-6 w-16 h-16 bg-slate-900 rounded-full border-2 ${borderColor} flex items-center justify-center">
                            <i data-lucide="${hero.icon || 'user'}" class="${iconColor} w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white">${hero.name}</h3>
                        <p class="${subTextColor} text-sm mb-4">${hero.class}</p>
                        <div class="flex gap-2 mb-4">${tagsHtml}</div>
                        <p class="text-slate-400 text-sm">${hero.description}</p>
                    </div>
                </div>`;
                heroesContainer.insertAdjacentHTML('beforeend', html);
            });

            const sessionContainer = document.getElementById('session-list');
            sessionContainer.innerHTML = '';
            data.sessions.forEach(session => {
                let borderClass = session.color === 'purple' ? 'border-purple-500' : 'border-amber-500';
                const html = `
                <div class="glass-panel p-6 rounded-lg border-l-4 ${borderClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold text-white">${session.title}</h4>
                        <span class="text-sm text-slate-400">${session.date}</span>
                    </div>
                    <p class="text-slate-300">${session.summary}</p>
                </div>`;
                sessionContainer.insertAdjacentHTML('beforeend', html);
            });
            lucide.createIcons();
        }

        function rollDuality() {
            const section = document.getElementById('dice-section');
            const hopeEl = document.getElementById('hope-die');
            const fearEl = document.getElementById('fear-die');
            const resultEl = document.getElementById('result-message');

            section.classList.remove('hidden');
            setTimeout(() => section.classList.remove('opacity-0'), 10);

            hopeEl.classList.add('rolling');
            fearEl.classList.add('rolling');
            resultEl.innerHTML = "Rolling...";

            setTimeout(() => {
                const hopeVal = Math.floor(Math.random() * 12) + 1;
                const fearVal = Math.floor(Math.random() * 12) + 1;

                hopeEl.classList.remove('rolling');
                fearEl.classList.remove('rolling');

                hopeEl.textContent = hopeVal;
                fearEl.textContent = fearVal;

                let outcome = "";
                let colorClass = "";
                
                if (hopeVal > fearVal) {
                    outcome = "HOPE";
                    colorClass = "text-amber-400";
                    if (hopeVal === 12 && fearVal === 12) outcome = "CRITICAL SUCCESS!";
                } else if (fearVal > hopeVal) {
                    outcome = "FEAR";
                    colorClass = "text-purple-400";
                    if (hopeVal === 12 && fearVal === 12) outcome = "CRITICAL SUCCESS!";
                } else {
                    outcome = "CRITICAL SUCCESS!";
                    colorClass = "text-emerald-400";
                }

                resultEl.innerHTML = `Result: <span class="${colorClass}">${outcome}</span> (Total: ${hopeVal + fearVal})`;
            }, 600);
        }
        
        function toggleDiceOverlay() {
            const section = document.getElementById('dice-section');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                setTimeout(() => section.classList.remove('opacity-0'), 10);
            } else {
                section.classList.add('opacity-0');
                setTimeout(() => section.classList.add('hidden'), 500);
            }
        }

        lucide.createIcons();
    </script>
</body>
</html>